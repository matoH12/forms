# ==========================================================================
# CRS Global Exclusions - Formulare (Laravel/Inertia.js)
# ==========================================================================
# Loaded AFTER CRS rules. Uses SecRuleRemoveById / SecRuleUpdateTargetById
# for configure-time (global) exclusions.
# ==========================================================================

# --------------------------------------------------------------------------
# Rule 920650: Detects _method parameter as HTTP method override bypass.
# Laravel uses _method=PUT/PATCH/DELETE as standard form method spoofing.
# This is NOT a WAF bypass - the application intentionally uses POST for
# all requests and _method tells Laravel which route to match.
# --------------------------------------------------------------------------
SecRuleRemoveById 920650

# --------------------------------------------------------------------------
# Exclude CSRF token from all rules.
# _token is a 40-char alphanumeric CSRF token present in every form.
# No point inspecting it - it's cryptographically random.
# --------------------------------------------------------------------------
SecRuleUpdateTargetByTag "OWASP_CRS" "!ARGS:_token"

# --------------------------------------------------------------------------
# Exclude _method field from all rules.
# Contains only literal strings: PUT, PATCH, DELETE.
# --------------------------------------------------------------------------
SecRuleUpdateTargetByTag "OWASP_CRS" "!ARGS:_method"

# --------------------------------------------------------------------------
# Exclude Inertia.js version header from protocol enforcement.
# X-Inertia-Version contains an asset hash (alphanumeric).
# --------------------------------------------------------------------------
SecRuleUpdateTargetById 920450 "!REQUEST_HEADERS:X-Inertia-Version"
SecRuleUpdateTargetById 920450 "!REQUEST_HEADERS:X-Inertia"
SecRuleUpdateTargetById 920450 "!REQUEST_HEADERS:X-HTTP-Method-Override"

# --------------------------------------------------------------------------
# Exclude PostHog analytics cookies from SQL injection detection.
# PostHog cookies (ph_phc_*_posthog) contain JSON with $ prefixed keys
# like $sesid, $direct, $initial_person_info which trigger MongoDB SQLi
# rule 942290 (detects $in operator pattern). This is a false positive.
# --------------------------------------------------------------------------
SecRuleUpdateTargetByTag "attack-sqli" "!REQUEST_COOKIES:/^ph_phc_/"

# --------------------------------------------------------------------------
# Exclude Google Analytics cookies from SQL injection detection.
# GA4 cookies (_ga_*) contain $ prefixed values ($o, $g, $t, $j, $l, $h)
# that trigger MongoDB SQLi detection (rule 942290), same as PostHog.
# --------------------------------------------------------------------------
SecRuleUpdateTargetByTag "attack-sqli" "!REQUEST_COOKIES:/^_ga/"

# --------------------------------------------------------------------------
# Exclude 'category' parameter from RCE detection.
# Category slugs are admin-defined (e.g. "docker-repository") and can
# contain Unix command names like "docker", "git", "node". Combined with
# a hyphen, CRS rule 932260 sees "docker-" as a command with flags.
# This parameter is only used for DB filtering, not shell execution.
# --------------------------------------------------------------------------
SecRuleUpdateTargetByTag "attack-rce" "!ARGS:category"
