# ==========================================================================
# CRS Exclusion Rules - Formulare (Laravel/Inertia.js)
# ==========================================================================
# Loaded BEFORE CRS rules. Uses ctl: actions for per-request tuning.
# IDs 99001-99099 reserved for this application.
#
# NOTE: libmodsecurity3 does NOT support regex in ctl: target args
# (e.g. ARGS:/^nodes/ fails). Use exact names or broad ARGS exclusion.
# ==========================================================================

# Body size limits - large JSON payloads (form schemas, workflow defs, backups)
SecRequestBodyNoFilesLimit 10485760
SecRequestBodyLimitAction ProcessPartial

# 1. Email templates - body_html contains full HTML, subject/body_text contain templates
#    Admin-only path: exclude all CRS from template content fields
#    Inertia sends as JSON (json.* prefix) or as form data (no prefix)
SecRule REQUEST_URI "@beginsWith /admin/email-templates" "id:99001,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body_html,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body_html,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:subject,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.subject,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:body_text,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body_text"

# 2. Workflows - nodes/edges contain API URLs, headers, email bodies, templates
#    Admin-only path: exclude all ARGS from CRS (contains arbitrary config data)
SecRule REQUEST_URI "@rx ^/admin/workflows" "id:99002,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 3. Workflows API variant
SecRule REQUEST_URI "@beginsWith /api/v1/admin/workflows" "id:99003,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 4. Forms - schema, settings, duplicate_message contain arbitrary field defs
#    Admin-only path: exclude all ARGS from CRS
SecRule REQUEST_URI "@rx ^/admin/forms" "id:99004,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 5. Forms API variant
SecRule REQUEST_URI "@beginsWith /api/v1/admin/forms" "id:99005,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 6. Categories - icon field contains SVG path data
#    Inertia sends as JSON (json.* prefix) or as form data (no prefix)
SecRule REQUEST_URI "@rx ^/admin/categories" "id:99006,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:icon,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:icon,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.icon,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.icon"

# 7. Public form submission - dynamic field names, exclude FP-prone rules
SecRule REQUEST_URI "@rx /forms/.+/submit$" "id:99007,phase:1,pass,nolog,ctl:ruleRemoveById=942100,ctl:ruleRemoveById=942250,ctl:ruleRemoveById=942270,ctl:ruleRemoveById=942361,ctl:ruleRemoveById=941100,ctl:ruleRemoveById=932235"

# 8. Backup restore - contains entire application dump
SecRule REQUEST_URI "@beginsWith /admin/settings/restore" "id:99008,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 9. Backup settings
SecRule REQUEST_URI "@beginsWith /admin/settings/backup" "id:99009,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 10. Settings - paths, credentials, URLs
#    Inertia sends as JSON (json.* prefix) or as form data (no prefix)
SecRule REQUEST_URI "@beginsWith /admin/settings" "id:99010,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:ftp_path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:s3_path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:s3_secret,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:secret,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:ftp_password,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:password,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:client_secret,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:base_url,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:redirect_uri,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:s3_endpoint,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:endpoint,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:link_url,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.ftp_path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.s3_path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.s3_secret,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.secret,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.ftp_password,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.password,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.client_secret,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.base_url,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.redirect_uri,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.s3_endpoint,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.endpoint,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.link_url"

# 11. Settings JSON - FTP/S3 test endpoints
SecRule REQUEST_URI "@rx ^/admin/settings/backup/test-(ftp|s3)" "id:99011,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.path,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.secret,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.password,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.endpoint"

# 12. Submission comments - freetext admin notes
SecRule REQUEST_URI "@rx ^/admin/submissions/[0-9]+/comments" "id:99012,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:content,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:content,ctl:ruleRemoveTargetByTag=attack-rce;ARGS:content,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.content,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.content,ctl:ruleRemoveTargetByTag=attack-rce;ARGS:json.content"

# 13. Approve/Reject - admin response text
SecRule REQUEST_URI "@rx /(submissions|forms)/.*/(approve|reject)" "id:99013,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:admin_response,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:admin_response,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.admin_response,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.admin_response"

# 14. Bulk operations - admin_response for batch approve/reject
#    Inertia sends as JSON (json.* prefix) or as form data (no prefix)
SecRule REQUEST_URI "@rx ^/admin/submissions/bulk-" "id:99014,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:admin_response,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:admin_response,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.admin_response,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.admin_response"

# 15. Import endpoints - arbitrary application data
SecRule REQUEST_URI "@beginsWith /api/v1/admin/import" "id:99015,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 16. Submission import - arbitrary form data
SecRule REQUEST_URI "@beginsWith /api/v1/submissions/import" "id:99016,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS"

# 17. Announcements - message text and link URL
#    Inertia sends as JSON (json.* prefix) or as form data (no prefix)
SecRule REQUEST_URI "@rx ^/admin/announcements" "id:99017,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:message,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:message,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:link_url,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.message,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.message,ctl:ruleRemoveTargetByTag=attack-rfi;ARGS:json.link_url"

# 18. Approval endpoints (public token-based from email links)
SecRule REQUEST_URI "@rx ^/(api/v1/)?approvals/" "id:99018,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:comment,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:comment,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.comment,ctl:ruleRemoveTargetByTag=attack-sqli;ARGS:json.comment"

# 19. File deletion - field name could match LFI patterns
SecRule REQUEST_URI "@rx ^/admin/submissions/[0-9]+/file$" "id:99019,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:field,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.field"

# 20. API email templates - same as rule 99001 for API variant
SecRule REQUEST_URI "@beginsWith /api/v1/admin/email-templates" "id:99020,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body_html,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.subject,ctl:ruleRemoveTargetByTag=OWASP_CRS;ARGS:json.body_text"

# 21. API categories - icon SVG
SecRule REQUEST_URI "@beginsWith /api/v1/admin/import/categories" "id:99021,phase:1,pass,nolog,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:icon,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:icon,ctl:ruleRemoveTargetByTag=attack-xss;ARGS:json.icon,ctl:ruleRemoveTargetByTag=attack-lfi;ARGS:json.icon"
