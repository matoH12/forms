# =============================================================================
# FORMULARE - Docker Compose Configuration
# =============================================================================
# Spustenie:
#   Standalone:    docker-compose --profile standalone up -d          (nginx na porte 8080)
#   S databazou:   docker-compose --profile standalone --profile full up -d
#   S Traefik:     docker-compose --profile proxy up -d              (cez Traefik HTTPS)
#   S WAF:         docker-compose --profile proxy --profile waf up -d
#   Produkcne:     docker-compose --profile proxy --profile waf --profile hardened up -d
#
# Profily:
#   standalone - Nginx s priamym pristupom na porte 8080 (bez proxy)
#   mysql      - Integrovany MySQL server
#   redis      - Integrovany Redis server
#   full       - MySQL + Redis s exposed portami
#   proxy      - Traefik reverse proxy s Let's Encrypt
#   waf        - ModSecurity WAF s OWASP Core Rule Set
#   hardened   - Ziadne externe exposed porty (pouzit s proxy)
# =============================================================================

version: '3.8'

# -----------------------------------------------------------------------------
# SERVICES
# -----------------------------------------------------------------------------

services:
  # ---------------------------------------------------------------------------
  # TRAEFIK - Reverse proxy s automatickym SSL (Let's Encrypt)
  # Konfiguracia cez labels - mozno pridavat dalsie kontajnery
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: formulare-traefik
    restart: unless-stopped
    profiles:
      - proxy
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
    networks:
      - formulare-network
    command:
      # API a Dashboard
      - "--api.dashboard=${TRAEFIK_DASHBOARD:-false}"
      - "--api.insecure=false"
      # Logging
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--accesslog=${TRAEFIK_ACCESS_LOG:-false}"
      # Docker provider - len cez labels
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=formulare-network"
      - "--providers.docker.watch=true"
      # Entry points
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # HTTP -> HTTPS redirect
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Let's Encrypt
      - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL:-admin@example.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      # Disable telemetry
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
    labels:
      - "traefik.enable=${TRAEFIK_DASHBOARD:-false}"
      # Dashboard na hlavnej domene s path prefixom /traefik/
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${TRAEFIK_DOMAIN:-localhost}`) && PathPrefix(`/traefik`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-strip,traefik-auth"
      # Strip /traefik prefix pred poslanim do dashboard API
      - "traefik.http.middlewares.traefik-strip.stripprefix.prefixes=/traefik"
      # Basic auth pre dashboard
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_DASHBOARD_AUTH:-admin:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj/}"

  # ---------------------------------------------------------------------------
  # WAF - ModSecurity s OWASP Core Rule Set
  # ---------------------------------------------------------------------------
  waf:
    build:
      context: ./docker/waf
      dockerfile: Dockerfile
    image: formulare-waf:latest
    container_name: formulare-waf
    restart: unless-stopped
    profiles:
      - waf
    environment:
      # Backend - kam sa presmeruje traffic po WAF kontrole
      - BACKEND=http://nginx-internal:80
      # Nginx listen port (must match traefik.http.services...server.port label)
      # NOTE: Port must be >1024 because the container runs as unprivileged user
      - PORT=8080
      # ModSecurity mode: On = blocking, DetectionOnly = logging only
      # Override via WAF_MODE env var in .env if needed
      - MODSEC_RULE_ENGINE=${WAF_MODE:-On}
      # Paranoia level (1-4, vyssia = prisnejsie pravidla)
      - PARANOIA=${WAF_PARANOIA_LEVEL:-1}
      # Anomaly scoring thresholds
      - ANOMALY_INBOUND=${WAF_ANOMALY_INBOUND:-5}
      - ANOMALY_OUTBOUND=${WAF_ANOMALY_OUTBOUND:-4}
      # Allowed methods (only POST needed - PUT/DELETE use method spoofing)
      - ALLOWED_METHODS=GET HEAD POST OPTIONS
      # Max request body size (MB)
      - MAX_REQUEST_BODY=${WAF_MAX_BODY:-100}
      # Request body inspection ON - inspects JSON/form payloads.
      # Exclusion rules in REQUEST-900 prevent false positives on admin fields.
      # Response body inspection OFF - not needed, Inertia responses are trusted.
      - MODSEC_REQ_BODY_ACCESS=On
      - MODSEC_RESP_BODY_ACCESS=Off
      # Disable specific rules if needed (comma separated)
      - MODSEC_DISABLE_RULES=${WAF_DISABLE_RULES:-}
      # Logging
      - ERRORLOG=/var/log/nginx/error.log
      - ACCESSLOG=/var/log/nginx/access.log
      # Proxy settings
      - PROXY_SSL=off
      - NGINX_ALWAYS_TLS_REDIRECT=off
      # Forward original Traefik headers to backend (default: $server_port/$scheme
      # which would be 8080/http - the WAF's internal values, not the client-facing ones)
      - NGINX_X_FORWARDED_PORT=$$http_x_forwarded_port
      - NGINX_X_FORWARDED_PROTO=$$http_x_forwarded_proto
    volumes:
      - waf-logs:/var/log/nginx
    networks:
      - formulare-network
    depends_on:
      nginx-internal:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    labels:
      - "traefik.enable=true"
      # Router - WAF je vstupny bod pre aplikaciu
      - "traefik.http.routers.formulare-waf.rule=Host(`${TRAEFIK_DOMAIN:-localhost}`)"
      - "traefik.http.routers.formulare-waf.entrypoints=websecure"
      - "traefik.http.routers.formulare-waf.tls.certresolver=letsencrypt"
      - "traefik.http.routers.formulare-waf.priority=10"
      # Service
      - "traefik.http.services.formulare-waf.loadbalancer.server.port=8080"
      # Security headers + rate limiting middleware
      - "traefik.http.routers.formulare-waf.middlewares=rate-limit@docker,security-headers@docker"
      # Rate limiting: 100 req/s per IP, burst up to 200
      - "traefik.http.middlewares.rate-limit.rateLimit.average=300"
      - "traefik.http.middlewares.rate-limit.rateLimit.burst=600"
      # Security headers definition
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.security-headers.headers.customFrameOptionsValue=SAMEORIGIN"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Powered-By="
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.Server="

  # ---------------------------------------------------------------------------
  # APP - PHP-FPM aplikacny server
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: formulare-app
    restart: unless-stopped
    working_dir: /var/www/html
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
      - app-public:/var/www/html/public
      - ./docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    networks:
      - formulare-network
    healthcheck:
      test: ["CMD-SHELL", "php-fpm-healthcheck || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-}
      - APP_URL=${APP_URL:-http://localhost:8080}
      # Trust Docker internal network proxies (Traefik, WAF, nginx)
      # These are private non-routable ranges - safe to trust in Docker
      - TRUSTED_PROXIES=${TRUSTED_PROXIES:-172.16.0.0/12,10.0.0.0/8}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-formulare}
      - DB_USERNAME=${DB_USERNAME:-formulare}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - RUN_SEEDERS=${RUN_SEEDERS:-false}
      - KEYCLOAK_BASE_URL=${KEYCLOAK_BASE_URL:-}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-}
      - KEYCLOAK_REDIRECT_URI=${KEYCLOAK_REDIRECT_URI:-}
      - ADMIN_EMAILS=${ADMIN_EMAILS:-}
      - ADMIN_USERNAMES=${ADMIN_USERNAMES:-}
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST:-}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-Formulare}
      - LOG_CHANNEL=${LOG_CHANNEL:-daily}
      - LOG_LEVEL=${LOG_LEVEL:-info}

  # ---------------------------------------------------------------------------
  # NGINX - Webovy server (priamy pristup - bez proxy)
  # Pouziva sa LEN v standalone mode (bez Traefik/WAF)
  # V proxy/waf/hardened mode sa pouziva nginx-internal
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: formulare-nginx
    restart: unless-stopped
    profiles:
      - standalone
    ports:
      - "${HTTP_PORT:-8080}:80"
    volumes:
      - app-public:/var/www/html/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - formulare-network
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nginx -t 2>/dev/null && kill -0 $$(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # Router - priamy pristup bez WAF (nizsia priorita)
      - "traefik.http.routers.formulare.rule=Host(`${TRAEFIK_DOMAIN:-localhost}`)"
      - "traefik.http.routers.formulare.entrypoints=websecure"
      - "traefik.http.routers.formulare.tls.certresolver=letsencrypt"
      - "traefik.http.routers.formulare.priority=5"
      # Service
      - "traefik.http.services.formulare.loadbalancer.server.port=80"
      # Security headers + rate limiting
      - "traefik.http.routers.formulare.middlewares=rate-limit@docker,security-headers-basic@docker"
      # Rate limiting: 100 req/s per IP, burst up to 200
      - "traefik.http.middlewares.rate-limit.rateLimit.average=300"
      - "traefik.http.middlewares.rate-limit.rateLimit.burst=600"
      - "traefik.http.middlewares.security-headers-basic.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers-basic.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers-basic.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers-basic.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers-basic.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers-basic.headers.customFrameOptionsValue=SAMEORIGIN"

  # ---------------------------------------------------------------------------
  # NGINX-INTERNAL - Webovy server pre proxy/WAF mod (ziadne exposed porty)
  # ---------------------------------------------------------------------------
  nginx-internal:
    image: nginx:alpine
    container_name: formulare-nginx-internal
    restart: unless-stopped
    profiles:
      - hardened
      - waf
    volumes:
      - app-public:/var/www/html/public:ro
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      formulare-network:
        aliases:
          - nginx-backend
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nginx -t 2>/dev/null && kill -0 $$(cat /var/run/nginx.pid 2>/dev/null) 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      # Router pre hardened mod bez WAF
      - "traefik.http.routers.formulare-internal.rule=Host(`${TRAEFIK_DOMAIN:-localhost}`)"
      - "traefik.http.routers.formulare-internal.entrypoints=websecure"
      - "traefik.http.routers.formulare-internal.tls.certresolver=letsencrypt"
      - "traefik.http.routers.formulare-internal.priority=1"
      # Service
      - "traefik.http.services.formulare-internal.loadbalancer.server.port=80"
      # Security headers + rate limiting
      - "traefik.http.routers.formulare-internal.middlewares=rate-limit@docker,security-headers@docker"
      # Rate limiting: 100 req/s per IP, burst up to 200
      - "traefik.http.middlewares.rate-limit.rateLimit.average=300"
      - "traefik.http.middlewares.rate-limit.rateLimit.burst=600"
      # Security headers (must be defined here, not only on waf service)
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.security-headers.headers.customFrameOptionsValue=SAMEORIGIN"
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.X-Powered-By="
      - "traefik.http.middlewares.security-headers.headers.customResponseHeaders.Server="

  # ---------------------------------------------------------------------------
  # MYSQL - Databazovy server (s exposed portom)
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.0.41
    container_name: formulare-mysql
    restart: unless-stopped
    profiles:
      - mysql
      - full
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-formulare}
      MYSQL_USER: ${DB_USERNAME:-formulare}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootsecret}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - formulare-network
    command: >
      --default-authentication-plugin=mysql_native_password
      --max_connections=200
      --innodb_buffer_pool_size=256M
      --innodb_redo_log_capacity=128M
      --innodb_flush_log_at_trx_commit=2
      --thread_cache_size=16
      --table_open_cache=400
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootsecret}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ---------------------------------------------------------------------------
  # MYSQL-INTERNAL - Databazovy server (bez exposed portu - hardened)
  # ---------------------------------------------------------------------------
  mysql-internal:
    image: mysql:8.0.41
    container_name: formulare-mysql-internal
    restart: unless-stopped
    profiles:
      - hardened
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-formulare}
      MYSQL_USER: ${DB_USERNAME:-formulare}
      MYSQL_PASSWORD: ${DB_PASSWORD:-secret}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootsecret}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      formulare-network:
        aliases:
          - mysql
    command: >
      --default-authentication-plugin=mysql_native_password
      --max_connections=200
      --innodb_buffer_pool_size=256M
      --innodb_redo_log_capacity=128M
      --innodb_flush_log_at_trx_commit=2
      --thread_cache_size=16
      --table_open_cache=400
      --bind-address=0.0.0.0
      --skip-name-resolve
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootsecret}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ---------------------------------------------------------------------------
  # REDIS - Cache a Queue server (s exposed portom)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.4-alpine
    container_name: formulare-redis
    restart: unless-stopped
    profiles:
      - redis
      - full
    ports:
      - "${REDIS_EXT_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - formulare-network
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # REDIS-INTERNAL - Cache a Queue server (bez exposed portu - hardened)
  # ---------------------------------------------------------------------------
  redis-internal:
    image: redis:7.4-alpine
    container_name: formulare-redis-internal
    restart: unless-stopped
    profiles:
      - hardened
    volumes:
      - redis-data:/data
    networks:
      formulare-network:
        aliases:
          - redis
    command: >
      redis-server
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --tcp-backlog 511
      --timeout 0
      --tcp-keepalive 300
      --protected-mode no
      --bind 0.0.0.0
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # QUEUE - Worker pre spracovanie uloh na pozadi
  # ---------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: formulare-queue
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600 --memory=256
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    networks:
      - formulare-network
    depends_on:
      app:
        condition: service_healthy
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-formulare}
      - DB_USERNAME=${DB_USERNAME:-formulare}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST:-}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-Formulare}

  # ---------------------------------------------------------------------------
  # QUEUE-HIGH - Worker pre prioritne ulohy
  # ---------------------------------------------------------------------------
  queue-high:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: formulare-queue-high
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan queue:work --queue=high,default --sleep=3 --tries=3 --max-time=3600 --memory=256
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    networks:
      - formulare-network
    depends_on:
      app:
        condition: service_healthy
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-formulare}
      - DB_USERNAME=${DB_USERNAME:-formulare}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - MAIL_MAILER=${MAIL_MAILER:-smtp}
      - MAIL_HOST=${MAIL_HOST:-}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_ENCRYPTION=${MAIL_ENCRYPTION:-tls}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-}
      - MAIL_FROM_NAME=${MAIL_FROM_NAME:-Formulare}

  # ---------------------------------------------------------------------------
  # SCHEDULER - Planovac uloh (cron)
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: formulare-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    volumes:
      - app-storage:/var/www/html/storage/app
      - app-logs:/var/www/html/storage/logs
    networks:
      - formulare-network
    depends_on:
      app:
        condition: service_healthy
    environment:
      - APP_ENV=${APP_ENV:-production}
      - APP_DEBUG=${APP_DEBUG:-false}
      - APP_KEY=${APP_KEY:-}
      - DB_CONNECTION=${DB_CONNECTION:-mysql}
      - DB_HOST=${DB_HOST:-mysql}
      - DB_PORT=${DB_PORT:-3306}
      - DB_DATABASE=${DB_DATABASE:-formulare}
      - DB_USERNAME=${DB_USERNAME:-formulare}
      - DB_PASSWORD=${DB_PASSWORD:-secret}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis

# -----------------------------------------------------------------------------
# NETWORKS
# -----------------------------------------------------------------------------
networks:
  formulare-network:
    driver: bridge
    name: formulare-network

# -----------------------------------------------------------------------------
# VOLUMES
# -----------------------------------------------------------------------------
volumes:
  mysql-data:
    name: formulare-mysql-data

  redis-data:
    name: formulare-redis-data

  app-storage:
    name: formulare-app-storage

  app-logs:
    name: formulare-app-logs

  app-public:
    name: formulare-app-public

  traefik-certs:
    name: formulare-traefik-certs

  waf-logs:
    name: formulare-waf-logs
